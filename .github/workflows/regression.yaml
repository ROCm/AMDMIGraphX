on:
  push:
    branches: [develop]
env:
  TEST: false
  DOCKERBASE: rocm-migraphx:5.1
  MIOPENTUNE: miopen-rocm51

name: MIGraphX Regression test

jobs: 
  # check_image_version:
  #   name: Check Image Version
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Check new image
  #       id: chk_img
  #       if: ${{ env.TEST == true }}
  #       run: exit 1
  build_image:
    name: Build New Image
    runs-on: self-hosted
    # needs: check_image_version
    steps:
      - name: Checkout code
        uses: actions/checkout@v1
        with:
          submodules: recursive
          token: ${{ secrets.GH_SUB_TOKEN }}
      - name: Docker build
        run: |
          cd ./rocm-migraphx/dockerfiles
          docker build -t "rocm-migraphx:$(date +%Y%m%d)" --no-cache --build-arg BRANCH=$GITHUB_REF_NAME --build-arg DOCKERBASE=${{ env.DOCKERBASE }} --build-arg MIOPENTUNE=${{ env.MIOPENTUNE }} -f dockerfile-daily .
  run_docker_image:
    name: Run image
    runs-on: self-hosted
    steps:
      - name: Run docker image
        run: |
          docker run -e TZ=America/Chicago -e TARGET=gpu --device=/dev/dri --device=/dev/kfd --network=host --group-add=video --name performance-test "rocm-migraphx:$(date +%Y%m%d)" /bin/bash
  execute_scripts:
    name: Execute scripts
    runs-on: self-hosted
    steps:
      - name: Execute perf script
        run: |
          docker exec performance-test ./rocm-migraphx/scripts/run_perf_mev.sh