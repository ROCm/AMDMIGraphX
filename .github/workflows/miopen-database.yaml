on:
  workflow_dispatch:
    inputs:
      release:
        description: ROCm release version
        required: true
      git-ref:
        description: Git Ref (Mandatory)
        required: false

name: MIOPEN Generate database

env:
  ROCM_VERSION: rocm-${{ github.event.inputs.release }}
  MIOPEN_PATH: miopen-databases
  
jobs:
  checkout_miopen:
    runs-on: r3
    name: Checkout MIOPEN Databases
    steps:
      - name: Checkout miopen-databases
        run: |
          rm -rf $GITHUB_WORKSPACE/${{ env.MIOPEN_PATH }}/
          git clone https://${{ secrets.GH_SUB_TOKEN }}@github.com/migraphx-benchmark/miopen-databases.git $GITHUB_WORKSPACE/${{ env.MIOPEN_PATH }}
  check_image_version:
    name: Check Image Version
    runs-on: self-hosted
    needs: checkout_miopen
    outputs:
      image: ${{ steps.check_image.outputs.image }}
    steps:
      - name: Check new image
        id: check_image
        run: |
          if [ ! -z "$(docker images -q rocm-migraphx:${{ github.event.inputs.release }})" ]; then
            echo "::set-output name=image::true"
          fi
      - name: test step
        run: echo "Value of image is ${{ steps.check_image.outputs.image }}"
  check_database:
    name: Check database path
    runs-on: r3
    needs: checkout_miopen
    outputs:
      database: ${{ steps.check_database.outputs.database }}
    steps:
      - name: Check db
        id: check_database
        run: |
          if [ ! -d "$GITHUB_WORKSPACE/${{ env.MIOPEN_PATH }}/${{ env.ROCM_VERSION }}/" ]; then
            echo "::set-output name=database::true"
          fi
      - name: test step
        run: |
          ls $GITHUB_WORKSPACE/${{ env.MIOPEN_PATH }}/
          echo "Value of database is ${{ steps.check_database.outputs.database }}"
  create_database:
    name: Create MIOPEN Database
    runs-on: r3
    needs: [check_image_version, check_database]
    if: ( needs.check_database.outputs.database == 'true' && needs.check_image_version.outputs.image == 'true' )
    steps:
      - name: Checkout code
        uses: actions/checkout@v1
        with:
          submodules: recursive
          token: ${{ secrets.GH_SUB_TOKEN }}
      - name: Perform tuning database
        env:
          MIOPEN_FIND_ENFORCE: 3
        run: >
          docker run -e TZ=America/Chicago
          -e TARGET=gpu
          --device=/dev/dri
          --device=/dev/kfd
          --network=host
          --group-add=video 
          -v /home/htec/jz:/data
          --workdir /data/source/rocm-migraphx/scripts/
          rocm-migraphx:${{ github.event.inputs.release }} /bin/bash -c "./run_perf_mev.sh; cp -r /root/.config/miopen /data/database"
      - name: Push database to git
        run: |
          cd $GITHUB_WORKSPACE/${{ env.MIOPEN_PATH }}/
          mkdir -p ${{env.ROCM_VERSION}}
          cp -r /home/htec/jz/database/ ${{env.ROCM_VERSION}}/MI-100
          git add .
          git config --local user.email github-actions
          git config --local user.name github-actions@github.com
          git commit -m "Push databases" -a
          git push

          